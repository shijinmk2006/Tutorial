CREATE TABLE [dbo].[Country](
	[pkCountry] [int] IDENTITY(1,1) NOT NULL,
	[Country] VARCHAR(50) NOT NULL,
 CONSTRAINT [PK_Country] PRIMARY KEY CLUSTERED 
(
	[pkCountry] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO


CREATE TABLE [dbo].[Entity](
	[pkEntity] [int] IDENTITY(1,1) NOT NULL,
	[fkCountry] [int] NOT NULL,
	[EntityName] [varchar](500) NOT NULL,

    CONSTRAINT [PK_Entity] PRIMARY KEY CLUSTERED 
(
	[pkEntity] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Entity]  WITH CHECK ADD  CONSTRAINT [FK_Entity_Country] FOREIGN KEY([fkCountry])
REFERENCES [dbo].[Country] ([pkCountry])
GO

ALTER TABLE [dbo].[Entity]  WITH CHECK ADD  CONSTRAINT [FK_Entity_Region] FOREIGN KEY([fkRegion])
REFERENCES [dbo].[Region] ([pkRegion])
GO


ALTER TABLE [dbo].[Entity]  WITH CHECK ADD  CONSTRAINT [FK_Entity_PayGruop] FOREIGN KEY([fkPayGroup])
REFERENCES [dbo].[PayGroup] ([pkPayGroup])
GO

ALTER TABLE [dbo].[Entity] ADD  DEFAULT ((1)) FOR [fkFileType]
GO

ALTER TABLE [dbo].[Entity]  WITH CHECK ADD  CONSTRAINT [FK_FileType] FOREIGN KEY([fkFileType])
REFERENCES [dbo].[FileType] ([pkFileType])
GO

ALTER TABLE [dbo].[Entity] ADD  DEFAULT ((0)) FOR [IsMapped]
GO

ALTER TABLE [dbo].[Entity] ADD  DEFAULT ((1)) FOR [IsSplitAllowed]
GO

CREATE TABLE [dbo].[PayrollCalendarMaster]
(
	[pkPayrollCalendarMaster] INT NOT NULL IDENTITY,
        [fkEntity] INT NOT NULL,
	[Year] INT NOT NULL,
	[Month] VARCHAR(10) NOT NULL,
    CONSTRAINT [PK_PayrollCalendarMaster] PRIMARY KEY ([pkPayrollCalendarMaster]),
    CONSTRAINT [FK_PayrollCalendarMaster_Entity] FOREIGN KEY ([fkEntity]) REFERENCES [Entity] ([pkEntity]) ON DELETE CASCADE
)


CREATE TABLE [dbo].[PayrollCalendar](
	[pkPayrollCalendar] [int] IDENTITY(1,1) NOT NULL,
	[fkPayrollCalendarFile] [int]  NULL,
	[fkPayrollCalendarMaster] INT NULL,
	[PayNumber] [varchar] (2) NULL,
	[PayrollType] [varchar](20) NULL,

	 SysStartTime datetime2 GENERATED ALWAYS AS ROW START NOT NULL
  ,SysEndTime datetime2 GENERATED ALWAYS AS ROW END NOT NULL
   ,PERIOD FOR SYSTEM_TIME (SysStartTime,SysEndTime),

 CONSTRAINT [PK_PayrollCalendar] PRIMARY KEY CLUSTERED 
(
	[pkPayrollCalendar] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.PayrollCalendarLog))

GO

ALTER TABLE [dbo].[PayrollCalendar] WITH CHECK ADD CONSTRAINT [FK_PayrollCalendar_PayrollCalendarMaster] FOREIGN KEY ([fkPayrollCalendarMaster])
REFERENCES [dbo].[PayrollCalendarMaster] ([pkPayrollCalendarMaster])
GO

ALTER TABLE [dbo].[PayrollCalendar] CHECK CONSTRAINT [FK_PayrollCalendar_PayrollCalendarMaster]
GO

ALTER TABLE [dbo].[PayrollCalendar]  WITH CHECK ADD  CONSTRAINT [FK_PayrollCalendar_Entity] FOREIGN KEY([fkEntity])
REFERENCES [dbo].[Entity] ([pkEntity])
GO

ALTER TABLE [dbo].[PayrollCalendar] CHECK CONSTRAINT [FK_PayrollCalendar_Entity]
GO



ALTER TABLE [dbo].[PayrollCalendar]  WITH CHECK ADD  CONSTRAINT [FK_PayrollCalendar_Currency] FOREIGN KEY([fkCurrency])
REFERENCES [dbo].[Currency] ([pkCurrency])
GO


ALTER TABLE [dbo].[PayrollCalendar]  WITH CHECK ADD  CONSTRAINT [FK_PayrollCalendar_PayrollCalendarFile] FOREIGN KEY([fkPayrollCalendarFile])
REFERENCES [dbo].[PayrollCalendarFile] ([pkPayrollCalendarFile])
GO

ALTER TABLE [dbo].[PayrollCalendar] CHECK CONSTRAINT [FK_PayrollCalendar_PayrollCalendarFile]
GO

CREATE TABLE [dbo].[FileQueueMaster]
(
	[pkFileQueueMaster] INT NOT NULL IDENTITY,
    [fkPayrollCalendarMaster] INT NOT NULL,
    [fkTemplate] INT NOT NULL,
    [fkFileUploadStatus] INT NOT NULL,
    PERIOD FOR SYSTEM_TIME ([SysStartTime], [SysEndTime]),
    CONSTRAINT [PK_FileQueueMaster] PRIMARY KEY ([pkFileQueueMaster]),
    CONSTRAINT [FK_FileQueueMaster_PayrollCalendarMaster] FOREIGN KEY ([fkPayrollCalendarMaster]) REFERENCES [PayrollCalendarMaster] ([pkPayrollCalendarMaster]),
    CONSTRAINT [FK_FileQueueMaster_Template] FOREIGN KEY ([fkTemplate]) REFERENCES [Template]([pkTemplate]),
    CONSTRAINT [FK_FileQueueMaster_FileUploadStatus] FOREIGN KEY ([fkFileUploadStatus]) REFERENCES [FileUploadStatus]([pkFileUploadStatus])
) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = [dbo].[FileQueueMasterLog]))


CREATE TABLE [dbo].[FileQueue]
(
	[pkFileQueue] INT IDENTITY(1,1) NOT NULL, 
    [fkFileQueueMaster] INT NULL,
    [fkPayrollCalendar] INT NOT NULL, 
    [fkFileUploadStatus] INT NOT NULL, 
    CONSTRAINT [PK_FileQueue] PRIMARY KEY CLUSTERED 
(
	[pkFileQueue] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
)WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.FileQueueLog))
GO

ALTER TABLE [dbo].[FileQueue]  WITH CHECK ADD  CONSTRAINT [FK_FileQueue_FileQueueMaster] FOREIGN KEY([fkFileQueueMaster])
REFERENCES [dbo].[FileQueueMaster] ([pkFileQueueMaster])
GO

ALTER TABLE [dbo].[FileQueue]  WITH CHECK ADD  CONSTRAINT [FK_FileQueue_PayrollCalendar] FOREIGN KEY([fkPayrollCalendar])
REFERENCES [dbo].[PayrollCalendar] ([pkPayrollCalendar])
GO

ALTER TABLE [dbo].[FileQueue]  WITH CHECK ADD  CONSTRAINT [FK_FileQueue_FileUploadStatus] FOREIGN KEY([fkFileUploadStatus])
REFERENCES [dbo].[FileUploadStatus] ([pkFileUploadStatus])
GO

CREATE NONCLUSTERED INDEX [IDX_fkPayrollCalendar]
    ON [dbo].[FileQueue]([fkPayrollCalendar] ASC);
GO


CREATE TABLE [dbo].[PayrollRegister]
(
	[pkPayrollRegister] [int] IDENTITY(1,1) NOT NULL,
	[fkFileQueue] [int] NOT NULL,
	[EMPID] VARCHAR(1000) NULL,
	--[EMPName] VARCHAR(30) NOT NULL,

	 CONSTRAINT [PK_PayrollRegister] PRIMARY KEY CLUSTERED ([pkPayrollRegister] ASC),  
	 CONSTRAINT [FK_PayrollRegister_FileQueue] FOREIGN KEY([fkFileQueue]) REFERENCES [dbo].[FileQueue] ([pkFileQueue])
)
GO


CREATE TABLE [dbo].[Demographics]
(
	[pkDemographics] [int] IDENTITY(1,1) NOT NULL,
	[fkFileQueueMaster] [int]  NULL,

CONSTRAINT [PK_Demographics] PRIMARY KEY CLUSTERED ([pkDemographics] ASC),
CONSTRAINT [FK_Demographics_FileQueueMaster] FOREIGN KEY([fkFileQueueMaster]) REFERENCES [dbo].[FileQueueMaster] ([pkFileQueueMaster])
)
GO


write a stored procedure with pkPayrollCalendar as UDT parameter with conditions followed below.

1. Delete from Payrollcalendar and related all table  with filequeue fileuploadstatus 3,6,5 and null
2. for fktemplate=1 there will be multiple entries in Filequeue for each PkFilequeuemaster
3. for fktemplate=2 there will not be entries in Filequeue


