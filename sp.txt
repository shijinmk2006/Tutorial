CREATE PROCEDURE [dbo].[usp_GetStagingData]
	@TemplateName VARCHAR(100),
	@FileQueueId int
	AS

DECLARE @columnList VARCHAR(MAX), @sql VARCHAR(MAX), @tableName VARCHAR(50),@tblPrimaryColumn VARCHAR(50)


SELECT @columnList = COALESCE(@columnList+',','') + 
    CASE 
        WHEN tc.columntype = 'Date' THEN 
            'TRY_PARSE([' + tc.DBColumnName + '] AS Date)' + tc.DBColumnName
        WHEN tc.DBColumnName = 'EMPID' THEN 
            'CASE WHEN TRY_CONVERT(FLOAT, [' + tc.DBColumnName + ']) IS NOT NULL THEN CAST(TRY_CONVERT(FLOAT, [' + tc.DBColumnName + ']) AS VARCHAR(255)) ELSE [' + tc.DBColumnName + '] END AS [' + tc.DBColumnName + ']'
        ELSE 
            '[' + tc.DBColumnName + ']'
    END
FROM templateColumn tc 
INNER JOIN Template t ON t.pkTemplate = tc.fkTemplate
WHERE t.TemplateName = @TemplateName

 SET @sql = 'SELECT ' + cast(@FileQueueId as varchar(10)) +'AS fkFileQueue, '+ @columnList + ' FROM PayRollRegisterStage WHERE fkFileQueue = '+cast(@FileQueueId as varchar(10))

 EXEC(@sql)

